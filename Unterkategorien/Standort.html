<!DOCTYPE html>
<html lang="de">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="/AufnameApp/css/style.css"> <!-- Gleiche CSS Datei -->
	<!-- Zuerst fields.js einbinden -->
	<script src="/AufnameApp/js/fields.js"></script>
	<!-- Dann speicher.js einbinden -->
	<script src="/AufnameApp/js/speicher.js"></script>
	<!-- Schließlich createLocation.js einbinden -->
	<script src="/AufnameApp/js/createLocation.js"></script>
	
	<title>Standort</title>


</head>
<body>
    <h1>Standortübersicht</h1>
    <p>Hier kannst du weitere Informationen über den Standort hinzufügen.</p>

	<label for="standortName">Standort Name:</label>
	<input type="text" id="standortName" placeholder="Standort eingeben">

	<label for="standortAdresse">Adresse:</label>
	<input type="text" id="standortAdresse" placeholder="Adresse eingeben">

	<label for="standortBemerkung">Bemerkung:</label>
	<input type="text" id="standortBemerkung" placeholder="Bemerkung hinzufügen">

	<!-- Eingabefeld für den Autor -->
	<label for="author">Autor</label>
	<input type="text" id="author" required>

	<div style="margin-top:12px;">
		<button onclick="window.location.href='Grundriss.html'">Grundriss</button>
		<button onclick="window.location.href='Energieversorgung.html'">Energieversorgung</button>
		<button onclick="window.location.href='Energieverteilung.html'">Energieverteilung</button>
	</div>

<p></p>

<button id="downloadLocationButton" data-download="true">Standort speichern</button>
<button id="backButton" onclick="confirmAndClear()">Zurück1</button>
	
<script>
console.log('Standort script loaded');

function confirmAndClear() {
    console.log('confirmAndClear called');
    if (confirm('Möchten Sie wirklich zurückgehen? Alle Daten werden gelöscht.')) {
        console.log('confirmAndClear: current keys', Object.keys(sessionStorage));
        sessionStorage.clear();
        console.log('confirmAndClear: after clear', Object.keys(sessionStorage));
        // also remove any leftover items just in case
        for (let i = sessionStorage.length - 1; i >= 0; i--) {
            sessionStorage.removeItem(sessionStorage.key(i));
        }
        window.location.href = '../index.html';
    } else {
        console.log('confirmAndClear: user cancelled');
    }
}

document.addEventListener('DOMContentLoaded', function() {
	console.log('DOMContentLoaded handler running');
	// Auto-detect EV_ keys in sessionStorage and reconstruct subpage metadata
	function detectAndCreateSubpages() {
		const subpagesByGroup = {};
		
		for (let i = 0; i < sessionStorage.length; i++) {
			const key = sessionStorage.key(i);
			if (!key) continue;
			
			let group = null;
			let rest = null;
			
			if (key.startsWith('EV_dist_')) {
				group = 'Energieverteilung';
				rest = key.slice(8);
			} else if (key.startsWith('EV_')) {
				group = 'Energieversorgung';
				rest = key.slice(3);
			}
			
			if (group && rest && window.fieldGroups && window.fieldGroups[group]) {
				const knownFields = window.fieldGroups[group];
				for (const field of knownFields) {
					const safField = field.replace(/\s+/g, '_');
					if (rest.endsWith(safField)) {
						const nameEnd = rest.length - safField.length - 1;
						if (nameEnd > 0) {
							const name = rest.slice(0, nameEnd).replace(/_/g, ' ');
							if (!subpagesByGroup[group]) subpagesByGroup[group] = new Set();
							subpagesByGroup[group].add(name);
							break;
						}
					}
				}
			}
		}
		
		// Store subpage metadata
		for (const group in subpagesByGroup) {
			const names = Array.from(subpagesByGroup[group]);
			if (names.length > 0) {
				sessionStorage.setItem(`subpages_${group}_names`, JSON.stringify(names));
			}
		}
	}

	// Auto-detect subpages on load
	detectAndCreateSubpages();

	// Populate form fields from sessionStorage if they exist
	const fields = ['standortName', 'standortAdresse', 'standortBemerkung', 'author'];
	fields.forEach(field => {
		const el = document.getElementById(field);
		const value = sessionStorage.getItem(field);
		if (el && value) el.value = value;
	});
});
</script>
</body>
</html>