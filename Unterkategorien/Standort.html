<!DOCTYPE html>
<html lang="de">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="/AufnameApp/css/style.css"> <!-- Gleiche CSS Datei -->
	<!-- Zuerst fields.js einbinden -->
	<script src="/AufnameApp/js/fields.js"></script>
	<!-- Dann speicher.js einbinden -->
	<script src="/AufnameApp/js/speicher.js"></script>
	<!-- Schließlich createLocation.js einbinden -->
	<script src="/AufnameApp/js/createLocation.js"></script>
	
	<title>Standort</title>


</head>
<body>
    <h1>Standortübersicht</h1>
    <p>Hier kannst du weitere Informationen über den Standort hinzufügen.</p>

	<label for="standortName">Standort Name:</label>
	<input type="text" id="standortName" placeholder="Standort eingeben">

	<label for="standortAdresse">Adresse:</label>
	<input type="text" id="standortAdresse" placeholder="Adresse eingeben">

	<label for="standortBemerkung">Bemerkung:</label>
	<input type="text" id="standortBemerkung" placeholder="Bemerkung hinzufügen">

	<!-- Eingabefeld für den Autor -->
	<label for="author">Autor</label>
	<input type="text" id="author" required>

    <!-- Hidden upload input: Übersicht/andere Seiten können diese auslösen -->
    <input type="file" id="uploadJsonStandort" accept="application/json" style="display:none">
	<!-- Upload-Steuerelement wird auf der Übersichtsseite getriggert; entfernt -->

	<div style="margin-top:12px;">
		<button onclick="window.location.href='Grundriss.html'">Grundriss</button>
		<button onclick="window.location.href='Energieversorgung.html'">Energieversorgung</button>
		<button onclick="window.location.href='Energieverteilung.html'">Energieverteilung</button>
	</div>

<p>

<button id="downloadLocationButton" data-download="true">Standort speichern</button>
<button onclick="window.location.href='../index.html'">Zurück</button>
	
</body>
<script>
document.addEventListener('DOMContentLoaded', function() {
	const params = new URLSearchParams(window.location.search);
	const mode = params.get('mode') || 'create';

	// Upload wird von der Übersichtsseite getriggert; im Edit-Modus werden sessionStorage-Werte geladen

	// Falls schon ein Name in sessionStorage ist, anzeigen
	const name = sessionStorage.getItem('editLocationName');
	if (name) {
		const el = document.getElementById('standortName');
		if (el) el.value = name;
	}

	// Falls bereits eine ganze JSON im sessionStorage liegt, parsen und Felder befüllen
	const storedJson = sessionStorage.getItem('editLocationJson');
	if (storedJson) {
		try {
			const data = JSON.parse(storedJson);
			const locationValue = data.standortName ?? data.standortname ?? data.location ?? data.Location ?? data.name ?? null;
			if (locationValue) {
				const el = document.getElementById('standortName');
				if (el) el.value = locationValue;
			}
			const adresseValue = data.address ?? data.adresse ?? data.Address ?? null;
			if (adresseValue) {
				const a = document.getElementById('standortAdresse');
				if (a) a.value = adresseValue;
			}
			const bemerkungValue = data.remark ?? data.bemerkung ?? data.note ?? null;
			if (bemerkungValue) {
				const b = document.getElementById('standortBemerkung');
				if (b) b.value = bemerkungValue;
			}
		} catch (e) {
			// ignore parse errors
		}
	}

	// JSON-Upload im Bearbeiten-Modus verarbeiten
	const uploadInput = document.getElementById('uploadJsonStandort');
	if (uploadInput) {
		uploadInput.addEventListener('change', function(event){
			const file = event.target.files[0];
			if (!file) return;
			const reader = new FileReader();
			reader.onload = function(e){
				try {
					const data = JSON.parse(e.target.result);
					// Put all keys from JSON into sessionStorage (strings)
					for (const k in data) {
						try {
							const v = data[k];
							if (v === null || v === undefined) continue;
							sessionStorage.setItem(k, String(v));
						} catch (err) {
							console.warn('Could not set sessionStorage for', k, err);
						}
					}

					// Reconstruct subpages from new format (EV_Name_Field, EV_dist_Name_Field)
					// Scan JSON for EV_* and EV_dist_* keys and group by name
					const subpagesByGroup = {};
					for (const jsonKey in data) {
						if (jsonKey.startsWith('EV_')) {
							let group = 'Energieversorgung';
							let rest = jsonKey.slice(3); // remove 'EV_'
							if (jsonKey.startsWith('EV_dist_')) {
								group = 'Energieverteilung';
								rest = jsonKey.slice(8); // remove 'EV_dist_'
							}
							if (!subpagesByGroup[group]) subpagesByGroup[group] = new Set();
							// rest = "Name_Field..." → extract name
							const lastUnder = rest.lastIndexOf('_');
							if (lastUnder > 0) {
								const name = rest.slice(0, lastUnder).replace(/_/g, ' ');
								subpagesByGroup[group].add(name);
							}
						}
					}
					// Store subpage metadata (names per group)
					for (const group in subpagesByGroup) {
						const names = Array.from(subpagesByGroup[group]);
						if (names.length > 0) {
							sessionStorage.setItem(`subpages_${group}_names`, JSON.stringify(names));
						}
					}

					// Populate some visible common fields for immediate feedback
					const locationValue = data.standortName ?? data.standortname ?? data.location ?? data.Location ?? data.name ?? null;
					if (locationValue) {
						sessionStorage.setItem('editLocationName', locationValue);
						try { sessionStorage.setItem('editLocationJson', JSON.stringify(data)); } catch (err) { }
						const el = document.getElementById('standortName');
						if (el) el.value = locationValue;
					}

					const adresseValue = data.address ?? data.adresse ?? data.Address ?? null;
					if (adresseValue) {
						const a = document.getElementById('standortAdresse');
						if (a) a.value = adresseValue;
					}
					const bemerkungValue = data.remark ?? data.bemerkung ?? data.note ?? null;
					if (bemerkungValue) {
						const b = document.getElementById('standortBemerkung');
						if (b) b.value = bemerkungValue;
					}
				} catch (err) {
					alert('Fehler beim Einlesen der JSON-Datei: ' + err.message);
				}
			};
			reader.readAsText(file);
		});
	}
}
);