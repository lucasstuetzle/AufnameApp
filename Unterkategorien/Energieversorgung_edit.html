<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/AufnameApp/css/style.css">
    <script src="/AufnameApp/js/fields.js"></script>
    <script src="/AufnameApp/js/subpageStorage.js"></script>
    <script src="/AufnameApp/js/calculatekWinA.js"></script>
    <title>Energieversorgung — Editor</title>
</head>
<body>
    <h1>Energieversorgung (Unterseite)</h1>

    <form id="subpageForm">
        <label for="BezeichnungEnergieversorgung">Name (erforderlich):</label>
        <input type="text" id="BezeichnungEnergieversorgung" required>

        <label for="Anschlussleistung kW">Anschlussleistung (kW):</label>
        <input type="number" id="Anschlussleistung kW">

        <label for="Anschlussleistung A">Anschlussleistung (A):</label>
        <input type="number" id="Anschlussleistung A">
    </form>

    <button id="saveSubpageBtn">Speichern</button>
    <button id="backBtn">Zurück</button>

    <script>
        (function(){
            const params = new URLSearchParams(window.location.search);
            const editName = params.get('name'); // for editing existing subpage
            const group = 'Energieversorgung';
            const fields = window.fieldGroups && window.fieldGroups[group] ? window.fieldGroups[group] : ['BezeichnungEnergieversorgung','Anschlussleistung kW','Anschlussleistung A'];

            function populate() {
                if (!editName) return; // new subpage
                const data = window.subpageStorage.getSubpage(group, editName, fields);
                for (const field in data) {
                    const el = document.getElementById(field);
                    if (el) el.value = data[field];
                }
            }

            document.getElementById('saveSubpageBtn').addEventListener('click', function(){
                const nameField = document.getElementById('BezeichnungEnergieversorgung');
                const name = nameField.value.trim();
                if (!name) {
                    alert('Name ist erforderlich!');
                    return;
                }

                // collect all field values
                const data = {};
                fields.forEach(f => {
                    const el = document.getElementById(f);
                    if (el) data[f] = el.value || '';
                });

                // save using new structured format
                window.subpageStorage.saveSubpage(group, name, data);

                // update metadata
                const names = window.subpageStorage.getSubpageNames(group);
                sessionStorage.setItem(`subpages_${group}_names`, JSON.stringify(names));

                window.location.href = 'Energieversorgung.html';
            });

            document.getElementById('backBtn').addEventListener('click', function(){ window.location.href = 'Energieversorgung.html'; });

            populate();
        })();
    </script>
</body>
</html>
