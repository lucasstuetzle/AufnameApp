<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/AufnameApp/css/style.css">
    <script src="/AufnameApp/js/fields.js"></script>
    <script src="/AufnameApp/js/subpageStorage.js"></script>
    <script src="/AufnameApp/js/calculatekWinA.js"></script>
    <title>Energieversorgung — Editor</title>
</head>
<body>
    <h1>Energieversorgung (Unterseite)</h1>

    <form id="subpageForm">
        <label for="BezeichnungEnergieversorgung">Name (erforderlich):</label>
        <input type="text" id="BezeichnungEnergieversorgung" required>

        <label for="Anschlussleistung kW">Anschlussleistung (kW):</label>
        <input type="number" id="Anschlussleistung kW">

        <label for="Anschlussleistung A">Anschlussleistung (A):</label>
        <input type="number" id="Anschlussleistung A">

        <!-- photo capture / upload -->
        <fieldset id="photoSection" style="margin-top:1em;">
            <legend>Foto hinzufügen/bearbeiten</legend>
            <input type="file" id="photoInput" accept="image/*" capture="environment">
            <p>Tippe/ziehe mit der Maus oder dem Finger, um auf dem Bild zu zeichnen.</p>
            <canvas id="photoCanvas" width="300" height="300" style="border:1px solid #ccc; touch-action: none;"></canvas>
            <button type="button" id="clearPhotoBtn">Foto entfernen</button>
        </fieldset>
    </form>

    <button id="saveSubpageBtn">Speichern</button>
    <button id="backBtn">Zurück</button>

    <script>
        (function(){
            const params = new URLSearchParams(window.location.search);
            const editName = params.get('name'); // for editing existing subpage
            const group = 'Energieversorgung';
            const fields = window.fieldGroups && window.fieldGroups[group] ? window.fieldGroups[group] : ['BezeichnungEnergieversorgung','Anschlussleistung kW','Anschlussleistung A'];

            function populate() {
                if (!editName) return; // new subpage
                const data = window.subpageStorage.getSubpage(group, editName, fields);
                for (const field in data) {
                    const el = document.getElementById(field);
                    if (el) el.value = data[field];
                }
                // photo data
                if (data.photo) {
                    const canvas = document.getElementById('photoCanvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0,0,canvas.width,canvas.height);
                        ctx.drawImage(img,0,0,canvas.width,canvas.height);
                    };
                    img.src = data.photo;
                }
            }

            document.getElementById('saveSubpageBtn').addEventListener('click', function(){
                const nameField = document.getElementById('BezeichnungEnergieversorgung');
                const name = nameField.value.trim();
                if (!name) {
                    alert('Name ist erforderlich!');
                    return;
                const data = {};

                // collect all field values
                fields.forEach(f => {
                    const el = document.getElementById(f);
                    if (el) data[f] = el.value || '';
                });

                // include photo if drawn
                const canvas = document.getElementById('photoCanvas');
                if (canvas) {
                    // if canvas is not empty (one simple way is to compare with blank)
                    try {
                        const blank = document.createElement('canvas');
                        blank.width = canvas.width;
                        blank.height = canvas.height;
                        if (canvas.toDataURL() !== blank.toDataURL()) {
                            data.photo = canvas.toDataURL('image/png');
                        }
                    } catch (e) {
                        console.warn('photo check failed', e);
                    }
                }

                // include photo if drawn
                const canvas = document.getElementById('photoCanvas');
                if (canvas) {
                    const blank = document.createElement('canvas');
                    blank.width = canvas.width;
                    blank.height = canvas.height;
                    if (canvas.toDataURL() !== blank.toDataURL()) {
                        data.photo = canvas.toDataURL('image/png');
                    }
                }

                // save using new structured format
                window.subpageStorage.saveSubpage(group, name, data);

                // update metadata
                const names = window.subpageStorage.getSubpageNames(group);
                sessionStorage.setItem(`subpages_${group}_names`, JSON.stringify(names));

                window.location.href = 'Energieversorgung.html';
            });

            document.getElementById('backBtn').addEventListener('click', function(){ window.location.href = 'Energieversorgung.html'; });

            // photo drawing support
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas ? canvas.getContext('2d') : null;
            let drawing = false;
            let lastX = 0, lastY = 0;
            function startDraw(x,y) { drawing = true; lastX = x; lastY = y; }
            function moveDraw(x,y) {
                if (!drawing || !ctx) return;
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                lastX = x; lastY = y;
            }
            function endDraw() { drawing = false; }
            if (canvas) {
                canvas.addEventListener('mousedown', e => startDraw(e.offsetX, e.offsetY));
                canvas.addEventListener('mousemove', e => moveDraw(e.offsetX, e.offsetY));
                canvas.addEventListener('mouseup', endDraw);
                canvas.addEventListener('mouseout', endDraw);
                canvas.addEventListener('touchstart', e => {
                    const rect = canvas.getBoundingClientRect();
                    const t = e.touches[0];
                    startDraw(t.clientX - rect.left, t.clientY - rect.top);
                    e.preventDefault();
                });
                canvas.addEventListener('touchmove', e => {
                    const rect = canvas.getBoundingClientRect();
                    const t = e.touches[0];
                    moveDraw(t.clientX - rect.left, t.clientY - rect.top);
                    e.preventDefault();
                });
                canvas.addEventListener('touchend', e => { endDraw(); e.preventDefault(); });
            }

            // photo input handling
            const photoInput = document.getElementById('photoInput');
            photoInput.addEventListener('change', function(e) {
                const file = this.files[0];
                if (!file) return;
                const img = new Image();
                const reader = new FileReader();
                reader.onload = function(evt) {
                    img.onload = function() {
                        // draw full canvas
                        if (ctx) {
                            ctx.clearRect(0,0,canvas.width,canvas.height);
                            ctx.drawImage(img,0,0,canvas.width,canvas.height);
                        }
                    };
                    img.src = evt.target.result;
                };
                reader.readAsDataURL(file);
            });
            document.getElementById('clearPhotoBtn').addEventListener('click', function(){
                if (ctx) ctx.clearRect(0,0,canvas.width,canvas.height);
                photoInput.value = '';
            });

            populate();
        })();
    </script>
</body>
</html>
