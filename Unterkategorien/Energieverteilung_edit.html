<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/AufnameApp/css/style.css">
    <script src="/AufnameApp/js/fields.js"></script>
    <script src="/AufnameApp/js/calculatekWinA.js"></script>
    <title>Energieverteilung — Editor</title>
</head>
<body>
    <h1>Energieverteilung (Unterseite)</h1>
    <form id="subpageForm">
        <label for="subpageTitle">Titel (optional)</label>
        <input type="text" id="subpageTitle">

        <label for="supply">Energiequelle:</label>
        <select id="supply">
            <option>Netzstrom</option>
            <option>Solar</option>
            <option>Wind</option>
            <option>Wasserkraft</option>
            <option>Batteriespeicher</option>
        </select>

        <label for="capacity">Kapazität (kW):</label>
        <input type="number" id="capacity" oninput="calculateEnergy()">

        <label for="time">Zeitdauer (h):</label>
        <input type="number" id="time" oninput="calculateEnergy()">

        <label for="energy">Energiemenge (kWh):</label>
        <input type="text" id="energy" readonly>

        <label for="Anzahl Ladepunkte">Anzahl Ladepunkte:</label>
        <input type="number" id="Anzahl Ladepunkte">

        <label for="lpMode">Modus:</label>
        <select id="lpMode">
            <option value="GLF">GLF</option>
            <option value="kW">kW/SP</option>
        </select>

        <label for="lpSlider">Wert:</label>
        <input type="range" id="lpSlider" min="0.1" max="1" step="0.1" value="1">
        <span id="lpSliderValue">1</span>

        <label for="requiredEnergy">Notwendige Energie (kW):</label>
        <input type="text" id="requiredEnergy" readonly>
    </form>

    <button id="saveSubpageBtn">Speichern</button>
    <button id="backBtn">Zurück</button>

    <script>
        (function(){
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const group = 'Energieverteilung';
            const fields = window.fieldGroups && window.fieldGroups[group] ? window.fieldGroups[group] : ['supply','capacity','time','energy','Anzahl Ladepunkte','lpMode','lpSlider','requiredEnergy'];

            function populate() {
                if (!id) return;
                fields.forEach(f => {
                    const el = document.getElementById(f);
                    if (!el) return;
                    const v = sessionStorage.getItem(f + id);
                    if (v !== null) el.value = v;
                });
                const t = sessionStorage.getItem(`subpageTitle_${group}_${id}`);
                if (t) document.getElementById('subpageTitle').value = t;
            }

            function ensureListContains(i) {
                const key = `subpages_${group}`;
                const raw = sessionStorage.getItem(key);
                const list = raw ? JSON.parse(raw) : [];
                if (!list.includes(i)) { list.push(Number(i)); sessionStorage.setItem(key, JSON.stringify(list)); }
            }

            document.getElementById('saveSubpageBtn').addEventListener('click', function(){
                let idx = id ? Number(id) : null;
                const key = `subpages_${group}`;
                const raw = sessionStorage.getItem(key);
                const list = raw ? JSON.parse(raw) : [];
                if (!idx) {
                    idx = list.length === 0 ? 1 : (Math.max(...list.map(i=>Number(i))) + 1);
                }
                fields.forEach(f => {
                    const el = document.getElementById(f);
                    const v = el ? el.value : '';
                    sessionStorage.setItem(f + idx, v);
                });
                const title = document.getElementById('subpageTitle').value.trim();
                if (title) sessionStorage.setItem(`subpageTitle_${group}_${idx}`, title);
                ensureListContains(idx);
                window.location.href = 'Energieverteilung.html';
            });

            document.getElementById('backBtn').addEventListener('click', function(){ window.location.href = 'Energieverteilung.html'; });

            populate();
        })();
    </script>
</body>
</html>
