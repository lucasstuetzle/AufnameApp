<!DOCTYPE html>
<html lang="de">
<head>
	<link rel="manifest" href="manifest.json">
	
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="stylesheet" href="/AufnameApp/css/style.css"> <!-- Gleiche CSS Datei -->
	
	<!-- Zuerst fields.js einbinden -->
	<script src="/AufnameApp/js/fields.js"></script>
	<!-- Dann speicher.js einbinden -->
	<script src="/AufnameApp/js/speicher.js"></script>
	<!-- Schlie√ülich createLocation.js einbinden -->
	<script src="/AufnameApp/js/createLocation.js"></script>

	<title>Standortauswahl</title>
</head>
	
<body>

    <h1>Standortauswahl</h1>
<p>


    <!-- Nur Auswahl: Neuer Standort oder Standort bearbeiten -->
    <button id="newLocationButton">Neuen Standort erstellen</button>
    <button id="editLocationButton" onclick="document.getElementById('uploadJson').click()">Standort bearbeiten</button>
    <!-- Separater Download-Button f√ºr Speichern/Export (aktiviert durch createLocation.js) -->


    <!-- Unsichtbarer File-Input f√ºr den JSON-Upload (wird vom Edit-Button ausgel√∂st) -->
    <input type="file" id="uploadJson" accept=".json" style="display:none">

	<button id="update-btn" style="position: fixed; bottom: 20px; right: 20px; padding: 10px; background-color: blue; color: white; border: none; border-radius: 5px; cursor: pointer;">
	  Aktualisieren üîÑ
	</button>

<script>
  document.getElementById('update-btn').addEventListener('click', () => {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistration().then(reg => {
        if (reg && reg.waiting) {
          // Falls ein neuer Service Worker wartet, diesen aktivieren
          reg.waiting.postMessage({ action: 'skipWaiting' });
        } else {
          // Falls kein neuer SW vorhanden, einfach Seite neu laden
          window.location.reload();
        }
      });
    } else {
      window.location.reload(); // Falls kein SW, einfach neuladen
    }
  });

  // Falls der neue Service Worker aktiviert wird, Seite neuladen
  if (navigator.serviceWorker) {
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      window.location.reload();
    });
  }
</script>

	
	
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
    .then(() => console.log('Service Worker registriert'))
    .catch(error => console.log('Service Worker Registrierung fehlgeschlagen:', error));
}
// Navigation handlers: create -> open Standort in create-mode, edit -> open Standort in edit-mode
document.getElementById('newLocationButton').addEventListener('click', function(){
  window.location.href = 'Unterkategorien/Standort.html?mode=create';
});

// Upload-Handler f√ºr Bearbeiten: Datei einlesen, in sessionStorage ablegen und zur Seite navigieren
const uploadJsonInput = document.getElementById('uploadJson');
if (uploadJsonInput) {
  uploadJsonInput.addEventListener('change', function(event){
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
      try {
        const data = JSON.parse(e.target.result);
        try { sessionStorage.setItem('editLocationJson', JSON.stringify(data)); } catch (err) { }

        // Wenn 'fields' definiert ist (wird in js/fields.js geladen), alle bekannten Felder √ºbernehmen
        if (typeof fields !== 'undefined' && Array.isArray(fields)) {
          fields.forEach(field => {
            let value = null;
            if (data[field] !== undefined && data[field] !== null) value = data[field];
            // Zus√§tzliche Synonyme f√ºr Adresse/Bemerkung pr√ºfen
            if (!value) {
              if (field === 'standortAdresse') value = data.address ?? data.adresse ?? data.Address ?? null;
              if (field === 'standortBemerkung') value = data.remark ?? data.bemerkung ?? data.note ?? null;
            }
            // Fallback: lowercase key
            if (!value && typeof field === 'string') {
              const low = field.charAt(0).toLowerCase() + field.slice(1);
              if (data[low] !== undefined) value = data[low];
            }
            if (value !== null && value !== undefined) {
              try { sessionStorage.setItem(field, value.toString()); } catch (err) { }
            }
          });
        } else {
          // Fallback: zumindest die √ºblichen Namen √ºbernehmen
          if (data.standortName) try { sessionStorage.setItem('standortName', data.standortName); } catch (err) {}
          if (data.location) try { sessionStorage.setItem('location', data.location); } catch (err) {}
        }

        // Bestimme einen Anzeige-/Dateinamen: priorisiere standortName, dann location/name/Location
        const nameCandidate = sessionStorage.getItem('standortName') || sessionStorage.getItem('location') || data.name || data.Location || data.standortName || null;
        if (nameCandidate) {
          try { sessionStorage.setItem('editLocationName', nameCandidate); } catch (err) { }
          window.location.href = 'Unterkategorien/Standort.html?mode=edit';
        } else {
          alert('Keine g√ºltige Namens-Eigenschaft (z.B. standortName oder location) in der JSON-Datei gefunden.');
        }
      } catch (err) {
        alert('Fehler beim Einlesen der JSON-Datei: ' + err.message);
      }
    };
    reader.readAsText(file);
  });
}
</script>

</body>
</html>





